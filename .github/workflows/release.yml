name: C++ CI Build & Draft Release

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build and upload artifacts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ make zip

      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build project
        run: cmake --build build --config Release -- -j$(nproc)

      - name: Package build
        run: |
          cd build
          zip -r ../cli-calculator-build.zip .
        shell: bash

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: cli-calculator-build
          path: build/
          retention-days: 7

      - name: Show diff for push
        id: show-diff
        if: ${{ github.event_name }} == 'push'
        run: |
            git diff ${{ github.event.before }} ${{ github.sha }}
      - name: Run AI inference
        id: inference
        uses: actions/ai-inference@v1
        with:
          prompt: |
            ### **Release Notes Generator – Specification**

            You are a release-notes generator. Your task is to produce clear, professional, feature-oriented release notes in **Markdown** format.

            ### **General Style Requirements**

            * Write in a formal, technical, developer-friendly tone.
            * Use concise, clear explanations.
            * Never describe internal code implementation unless it directly affects functionality.
            * Never mention diffs, patches, commits, or file lists — only summarize the resulting changes.

            ### **Required Structure**

            Your output must always contain the following top-level sections **in this exact order**:

            ---

            ### **Title**

            **Format:**
            `Release Notes – <Short descriptive version title>`

            ---

            ### **New Features**

            * Use bullet points.
            * Group features into **2–5 bolded subgroups**, each with a short title.

            **Example format:**

            **Advanced Expression Evaluation**
            • Added support for …
            • Improved …
            • Added error handling for …

            **Equation Solver**
            • Introduced interactive solver for …
            • Supports real, double, and complex roots …

            ---

            ### **Improvements**

            * Describe enhancements to existing logic, UI, performance, or stability.
            * Use bullet points.
            * Each improvement must explain **why it matters**.

            ---

            ### **Input Handling & Error Handling**

            This dedicated section must list items such as:

            * More robust validation
            * Better parsing
            * Enhanced user feedback
            * Improved diagnostics
            * Stability fixes

            If there are no updates, write: **No major changes.**

            ---

            ### **Documentation Updates**

            * List any newly documented features or changes.

            ---

            ### **Summary**

            A final paragraph that explains how the release improves the application overall.
            Tone: **confident, professional, authoritative**.

            ---

            ### **Formatting Rules**

            * Use **only Markdown**.
            * Do not include code blocks unless absolutely necessary.
            * Do not use headers smaller than `###`.
            * Every list item must begin consistently with either "-" or "•".

            ---

            ### **Behavior Constraints**

            * Never mention that you are an AI.
            * Never reference the prompt itself.
            * Never ask questions.
            * Output the release notes immediately and directly.

            ${{ steps.show-diff.outputs.diff }}
      - name: Create draft release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: v${{ github.run_number }}
          name: "CLI Calculator build #${{ github.run_number }}"
          files: cli-calculator-build.zip
          body: |
            ${{ steps.inference.outputs.response }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
